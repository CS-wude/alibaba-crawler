{% extends "base.html" %}

{% block title %}èƒ¸éƒ¨Xå…‰ç‰‡AIåˆ†æ - æ™ºèƒ½åŒ»å­¦å½±åƒè¯Šæ–­{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-white mb-3">
                <i class="fas fa-lungs me-3"></i>
                èƒ¸éƒ¨Xå…‰ç‰‡AIåˆ†æç³»ç»Ÿ
            </h1>
            <p class="lead text-white-50 mb-4">
                åŸºäºæ·±åº¦å­¦ä¹ çš„æ™ºèƒ½åŒ»å­¦å½±åƒåˆ†æï¼Œæä¾›ä¸“ä¸šçš„è¯Šæ–­è¾…åŠ©æœåŠ¡
            </p>
            <div class="row text-center text-white-50">
                <div class="col-md-4">
                    <i class="fas fa-brain fa-2x mb-2"></i>
                    <p>AIæ™ºèƒ½åˆ†æ</p>
                </div>
                <div class="col-md-4">
                    <i class="fas fa-file-medical fa-2x mb-2"></i>
                    <p>åŒ»å­¦æŠ¥å‘Šç”Ÿæˆ</p>
                </div>
                <div class="col-md-4">
                    <i class="fas fa-shield-alt fa-2x mb-2"></i>
                    <p>å®‰å…¨å¯é </p>
                </div>
            </div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="card shadow-lg mb-5">
            <div class="card-header bg-medical-light">
                <h4 class="card-title mb-0">
                    <i class="fas fa-upload me-2 text-primary"></i>
                    ä¸Šä¼ Xå…‰ç‰‡å›¾åƒ
                </h4>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-4">
                        <div class="upload-area p-5 text-center border-2 border-dashed rounded-3" 
                             style="border-color: var(--secondary-color); transition: var(--transition);"
                             ondrop="dropHandler(event);" ondragover="dragOverHandler(event);" 
                             ondragenter="dragEnterHandler(event);" ondragleave="dragLeaveHandler(event);">
                            
                            <div id="upload-content">
                                <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                                <h5 class="mb-3">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</h5>
                                <p class="text-muted mb-3">
                                    æ”¯æŒæ ¼å¼ï¼šPNG, JPG, JPEG, GIF, BMP, TIFF<br>
                                    æœ€å¤§æ–‡ä»¶å¤§å°ï¼š16MB
                                </p>
                                <input type="file" class="form-control d-none" id="fileInput" name="file" accept="image/*" required>
                                <button type="button" class="btn btn-primary" onclick="$('#fileInput').click()">
                                    <i class="fas fa-folder-open me-2"></i>é€‰æ‹©æ–‡ä»¶
                                </button>
                            </div>
                            
                            <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
                            <div id="file-preview" class="d-none">
                                <img id="preview-image" class="img-fluid rounded mb-3" style="max-height: 300px;">
                                <div id="file-info" class="text-start">
                                    <p class="mb-1"><strong>æ–‡ä»¶åï¼š</strong><span id="file-name"></span></p>
                                    <p class="mb-1"><strong>æ–‡ä»¶å¤§å°ï¼š</strong><span id="file-size"></span></p>
                                    <p class="mb-3"><strong>å›¾ç‰‡å°ºå¯¸ï¼š</strong><span id="image-dimensions"></span></p>
                                </div>
                                <!-- AIæŠ¥å‘Šç±»å‹é€‰æ‹© -->
                                <div class="card border-info mb-3">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-robot me-2"></i>AIæŠ¥å‘Šç±»å‹é€‰æ‹©</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <input class="form-check-input me-3" type="checkbox" id="useOllamaSwitch" checked>
                                                <label class="form-check-label" for="useOllamaSwitch">
                                                    <strong>ä½¿ç”¨å®Œæ•´AIåŒ»å­¦æŠ¥å‘Š</strong>
                                                </label>
                                            </div>
                                            <i class="fas fa-info-circle text-info" data-bs-toggle="tooltip" 
                                               title="åˆ‡æ¢æŠ¥å‘Šç”Ÿæˆæ–¹å¼"></i>
                                        </div>
                                        
                                        <!-- æŠ¥å‘Šç±»å‹è¯´æ˜ -->
                                        <div id="report-type-description" class="mt-3 p-3 rounded">
                                            <!-- è¿™é‡Œå°†é€šè¿‡JavaScriptåŠ¨æ€æ›´æ–° -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2 justify-content-center">
                                    <button type="submit" class="btn btn-success" id="analyzeBtn">
                                        <i class="fas fa-magic me-2"></i>å¼€å§‹åˆ†æ
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="resetUpload()">
                                        <i class="fas fa-times me-2"></i>é‡æ–°é€‰æ‹©
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åˆ†æè¿›åº¦ -->
                    <div id="analysis-progress" class="d-none">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="spinner-border text-primary me-3" role="status"></div>
                                    <div>
                                        <h6 class="mb-1">æ­£åœ¨åˆ†æå›¾åƒ...</h6>
                                        <p class="text-muted mb-0" id="progress-text">AIæ­£åœ¨å¤„ç†æ‚¨çš„Xå…‰ç‰‡ï¼Œè¯·ç¨å€™</p>
                                    </div>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         id="progress-bar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- åˆ†æç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div id="results-section" class="d-none">
            <div class="card shadow-lg">
                <div class="card-header bg-medical-light">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-clipboard-list me-2 text-success"></i>
                        åˆ†æç»“æœ
                    </h4>
                </div>
                <div class="card-body">
                    <!-- å¿«é€Ÿç»“æœæ¦‚è§ˆ -->
                    <div id="quick-results" class="row mb-4">
                        <!-- è¿™é‡Œå°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                    
                    <!-- è¯¦ç»†ç»“æœæ ‡ç­¾é¡µ -->
                    <ul class="nav nav-pills nav-fill mb-4" id="resultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="pill" data-bs-target="#basic-results" type="button" role="tab">
                                <i class="fas fa-chart-pie me-2"></i>åŸºç¡€åˆ†æ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="medical-tab" data-bs-toggle="pill" data-bs-target="#medical-results" type="button" role="tab">
                                <i class="fas fa-stethoscope me-2"></i>åŒ»å­¦æŠ¥å‘Š
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="recommendations-tab" data-bs-toggle="pill" data-bs-target="#recommendations-results" type="button" role="tab">
                                <i class="fas fa-lightbulb me-2"></i>å»ºè®®
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="resultTabContent">
                        <!-- åŸºç¡€åˆ†ææ ‡ç­¾é¡µ -->
                        <div class="tab-pane fade show active" id="basic-results" role="tabpanel">
                            <div id="basic-analysis-content">
                                <!-- é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                            </div>
                        </div>
                        
                        <!-- åŒ»å­¦æŠ¥å‘Šæ ‡ç­¾é¡µ -->
                        <div class="tab-pane fade" id="medical-results" role="tabpanel">
                            <div id="medical-report-content">
                                <!-- é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                            </div>
                        </div>
                        
                        <!-- å»ºè®®æ ‡ç­¾é¡µ -->
                        <div class="tab-pane fade" id="recommendations-results" role="tabpanel">
                            <div id="recommendations-content">
                                <!-- é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="text-center mt-4">
                        <button class="btn btn-primary me-2" id="downloadReportBtn" onclick="downloadReport()">
                            <i class="fas fa-download me-2"></i>ä¸‹è½½æŠ¥å‘Š
                        </button>
                        <button class="btn btn-info me-2" id="viewDetailedReportBtn" onclick="viewDetailedReport()">
                            <i class="fas fa-eye me-2"></i>æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
                        </button>
                        <button class="btn btn-secondary" onclick="resetAll()">
                            <i class="fas fa-refresh me-2"></i>é‡æ–°åˆ†æ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="card mt-5 bg-light">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-info-circle me-2 text-info"></i>
                    ä½¿ç”¨è¯´æ˜
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <h6>ğŸ“‹ æ“ä½œæ­¥éª¤ï¼š</h6>
                        <ol class="text-muted">
                            <li>é€‰æ‹©æˆ–æ‹–æ‹½èƒ¸éƒ¨Xå…‰ç‰‡å›¾åƒ</li>
                            <li>ç‚¹å‡»"å¼€å§‹åˆ†æ"ç­‰å¾…AIå¤„ç†</li>
                            <li>æŸ¥çœ‹è¯¦ç»†çš„åˆ†æç»“æœå’Œå»ºè®®</li>
                            <li>å¯ä¸‹è½½å®Œæ•´æŠ¥å‘Šä¿å­˜</li>
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <h6>âš ï¸ é‡è¦æé†’ï¼š</h6>
                        <ul class="text-muted">
                            <li>æœ¬ç³»ç»Ÿä»…ä¾›è¾…åŠ©è¯Šæ–­å‚è€ƒ</li>
                            <li>ä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç”Ÿçš„è¯Šæ–­</li>
                            <li>å¦‚æœ‰å¥åº·æ‹…å¿§è¯·åŠæ—¶å°±åŒ»</li>
                            <li>ä¸Šä¼ çš„å›¾åƒä¼šå®‰å…¨å¤„ç†å’Œå­˜å‚¨</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentAnalysisId = null;
    let selectedFile = null;

    // æ–‡ä»¶é€‰æ‹©å¤„ç†
    $('#fileInput').on('change', function(e) {
        handleFileSelect(e.target.files[0]);
    });

    // AIæŠ¥å‘Šç±»å‹å¼€å…³å¤„ç†
    $('#useOllamaSwitch').on('change', function() {
        updateReportTypeDescription();
    });

    // åˆå§‹åŒ–æŠ¥å‘Šç±»å‹è¯´æ˜
    updateReportTypeDescription();

    // æ‹–æ‹½å¤„ç†å‡½æ•°
    function dragOverHandler(ev) {
        ev.preventDefault();
        $('.upload-area').addClass('border-primary bg-light');
    }

    function dragEnterHandler(ev) {
        ev.preventDefault();
    }

    function dragLeaveHandler(ev) {
        ev.preventDefault();
        $('.upload-area').removeClass('border-primary bg-light');
    }

    function dropHandler(ev) {
        ev.preventDefault();
        $('.upload-area').removeClass('border-primary bg-light');
        
        const files = ev.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    }

    function handleFileSelect(file) {
        if (!file) return;
        
        // éªŒè¯æ–‡ä»¶ç±»å‹
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/bmp', 'image/tiff'];
        if (!allowedTypes.includes(file.type)) {
            showNotification('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾åƒæ–‡ä»¶', 'warning');
            return;
        }
        
        // éªŒè¯æ–‡ä»¶å¤§å° (16MB)
        if (file.size > 16 * 1024 * 1024) {
            showNotification('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡16MB', 'warning');
            return;
        }
        
        selectedFile = file;
        
        // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
        const reader = new FileReader();
        reader.onload = function(e) {
            $('#preview-image').attr('src', e.target.result);
            $('#file-name').text(file.name);
            $('#file-size').text(formatFileSize(file.size));
            
            // è·å–å›¾ç‰‡å°ºå¯¸
            const img = new Image();
            img.onload = function() {
                $('#image-dimensions').text(`${this.width} Ã— ${this.height} åƒç´ `);
            };
            img.src = e.target.result;
            
            // åˆ‡æ¢æ˜¾ç¤ºå†…å®¹
            $('#upload-content').addClass('d-none');
            $('#file-preview').removeClass('d-none');
        };
        reader.readAsDataURL(file);
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // é‡ç½®ä¸Šä¼ 
    function resetUpload() {
        selectedFile = null;
        $('#fileInput').val('');
        $('#upload-content').removeClass('d-none');
        $('#file-preview').addClass('d-none');
        $('#analysis-progress').addClass('d-none');
    }

    // é‡ç½®æ‰€æœ‰
    function resetAll() {
        resetUpload();
        $('#results-section').addClass('d-none');
        currentAnalysisId = null;
    }

    // æ›´æ–°æŠ¥å‘Šç±»å‹æè¿°
    function updateReportTypeDescription() {
        const useOllama = $('#useOllamaSwitch').prop('checked');
        const descriptionEl = $('#report-type-description');
        
        if (useOllama) {
            descriptionEl.html(`
                <div class="d-flex align-items-center">
                    <i class="fas fa-robot fa-2x text-primary me-3"></i>
                    <div>
                        <h6 class="mb-1 text-primary">ğŸ¤– å®Œæ•´AIåŒ»å­¦æŠ¥å‘Š</h6>
                        <p class="mb-0 text-muted">
                            <small>
                                ä½¿ç”¨Ollamaå¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆè‡ªç„¶è¯­è¨€åŒ»å­¦æŠ¥å‘Š<br>
                                â€¢ ä¸ªæ€§åŒ–åˆ†æå’Œå»ºè®®<br>
                                â€¢ è‡ªç„¶è¯­è¨€è¡¨è¾¾ï¼Œæ˜“äºç†è§£<br>
                                â€¢ ç»“åˆAIå›¾åƒåˆ†æå’ŒåŒ»å­¦çŸ¥è¯†
                            </small>
                        </p>
                    </div>
                </div>
            `).removeClass('bg-secondary').addClass('bg-primary bg-opacity-10 border-primary');
        } else {
            descriptionEl.html(`
                <div class="d-flex align-items-center">
                    <i class="fas fa-file-medical-alt fa-2x text-success me-3"></i>
                    <div>
                        <h6 class="mb-1 text-success">ğŸ“‹ å¢å¼ºç‰ˆä¸“ä¸šæŠ¥å‘Š</h6>
                        <p class="mb-0 text-muted">
                            <small>
                                åŸºäºè§„åˆ™ç”Ÿæˆç»“æ„åŒ–åŒ»å­¦æŠ¥å‘Š<br>
                                â€¢ ä¸“ä¸šåŒ»å­¦æ ¼å¼<br>
                                â€¢ è¯¦ç»†çš„ä¸´åºŠå‘ç°å’Œå»ºè®®<br>
                                â€¢ å¿«é€Ÿç”Ÿæˆï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡
                            </small>
                        </p>
                    </div>
                </div>
            `).removeClass('bg-primary border-primary').addClass('bg-success bg-opacity-10 border-success');
        }
    }

    // è¡¨å•æäº¤å¤„ç†
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!selectedFile) {
            showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'warning');
            return;
        }
        
        // æ˜¾ç¤ºè¿›åº¦
        $('#file-preview').addClass('d-none');
        $('#analysis-progress').removeClass('d-none');
        
        // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
        simulateProgress();
        
        // åˆ›å»ºFormData
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        // æ·»åŠ æŠ¥å‘Šç±»å‹é€‰æ‹©
        const useOllama = $('#useOllamaSwitch').prop('checked');
        formData.append('use_ollama', useOllama);
        
        // å‘é€è¯·æ±‚
        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                hideProgress();
                displayResults(response);
                showNotification('åˆ†æå®Œæˆï¼', 'success');
            },
            error: function(xhr, status, error) {
                hideProgress();
                const errorMsg = xhr.responseJSON?.error || 'åˆ†æè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯';
                showNotification(errorMsg, 'danger');
                resetUpload();
            }
        });
    });

    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
    function simulateProgress() {
        let progress = 0;
        const progressTexts = [
            'AIæ­£åœ¨å¤„ç†æ‚¨çš„Xå…‰ç‰‡...',
            'æ­£åœ¨åˆ†æå›¾åƒç‰¹å¾...',
            'æ­£åœ¨ç”Ÿæˆè¯Šæ–­ç»“æœ...',
            'æ­£åœ¨ç”ŸæˆåŒ»å­¦æŠ¥å‘Š...',
            'åˆ†æå³å°†å®Œæˆ...'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            
            $('#progress-bar').css('width', progress + '%');
            
            const textIndex = Math.floor(progress / 20);
            if (textIndex < progressTexts.length) {
                $('#progress-text').text(progressTexts[textIndex]);
            }
        }, 500);
        
        // ä¿å­˜intervalå¼•ç”¨ä»¥ä¾¿æ¸…é™¤
        window.progressInterval = interval;
    }

    // éšè—è¿›åº¦
    function hideProgress() {
        if (window.progressInterval) {
            clearInterval(window.progressInterval);
        }
        $('#progress-bar').css('width', '100%');
        setTimeout(() => {
            $('#analysis-progress').addClass('d-none');
        }, 500);
    }

    // æ˜¾ç¤ºç»“æœ
    function displayResults(data) {
        currentAnalysisId = data.file_info?.analysis_id;
        
        // æ˜¾ç¤ºå¿«é€Ÿç»“æœ
        displayQuickResults(data);
        
        // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
        displayBasicAnalysis(data);
        displayMedicalReport(data);
        displayRecommendations(data);
        
        // æ˜¾ç¤ºç»“æœåŒºåŸŸ
        $('#results-section').removeClass('d-none');
        
        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
        $('html, body').animate({
            scrollTop: $('#results-section').offset().top - 100
        }, 1000);
    }

    // æ˜¾ç¤ºå¿«é€Ÿç»“æœ
    function displayQuickResults(data) {
        const imageAnalysis = data.image_analysis;
        const assessment = data.comprehensive_assessment || {};
        const riskLevel = assessment.risk_assessment?.level || 'æœªçŸ¥';
        const confidence = (imageAnalysis.confidence * 100).toFixed(1);
        
        // ç¡®å®šé¢œè‰²ä¸»é¢˜
        let riskColor = 'primary';
        if (riskLevel.includes('é«˜é£é™©')) riskColor = 'danger';
        else if (riskLevel.includes('ä¸­é£é™©')) riskColor = 'warning';
        else if (riskLevel.includes('ä½é£é™©')) riskColor = 'info';
        else if (riskLevel.includes('æ­£å¸¸')) riskColor = 'success';
        
        const quickResultsHtml = `
            <div class="col-md-3">
                <div class="card border-${riskColor}">
                    <div class="card-body text-center">
                        <i class="fas fa-clipboard-check fa-2x text-${riskColor} mb-2"></i>
                        <h6 class="card-title">é¢„æµ‹ç»“æœ</h6>
                        <p class="card-text"><strong>${imageAnalysis.predicted_class === 'NORMAL' ? 'æ­£å¸¸' : 'ç–‘ä¼¼è‚ºç‚'}</strong></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                        <h6 class="card-title">ç½®ä¿¡åº¦</h6>
                        <p class="card-text"><strong>${confidence}%</strong></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-${riskColor}">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-${riskColor} mb-2"></i>
                        <h6 class="card-title">é£é™©ç­‰çº§</h6>
                        <p class="card-text"><strong>${riskLevel}</strong></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-secondary">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-secondary mb-2"></i>
                        <h6 class="card-title">åˆ†ææ—¶é—´</h6>
                        <p class="card-text"><strong>${new Date(imageAnalysis.prediction_time).toLocaleTimeString()}</strong></p>
                    </div>
                </div>
            </div>
        `;
        
        $('#quick-results').html(quickResultsHtml);
    }

    // æ˜¾ç¤ºåŸºç¡€åˆ†æ
    function displayBasicAnalysis(data) {
        const imageAnalysis = data.image_analysis;
        const probabilities = imageAnalysis.probabilities;
        
        const basicHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-chart-pie me-2 text-primary"></i>åˆ†ç±»æ¦‚ç‡åˆ†å¸ƒ</h5>
                    <div class="mb-3">
                        <label class="form-label">æ­£å¸¸ (NORMAL)</label>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" style="width: ${(probabilities.NORMAL * 100).toFixed(1)}%"></div>
                        </div>
                        <small class="text-muted">${(probabilities.NORMAL * 100).toFixed(1)}%</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è‚ºç‚ (PNEUMONIA)</label>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-danger" style="width: ${(probabilities.PNEUMONIA * 100).toFixed(1)}%"></div>
                        </div>
                        <small class="text-muted">${(probabilities.PNEUMONIA * 100).toFixed(1)}%</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5><i class="fas fa-info-circle me-2 text-info"></i>å›¾åƒä¿¡æ¯</h5>
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td><strong>æ–‡ä»¶å:</strong></td>
                                <td>${data.file_info?.filename || 'æœªçŸ¥'}</td>
                            </tr>
                            <tr>
                                <td><strong>å›¾åƒå°ºå¯¸:</strong></td>
                                <td>${imageAnalysis.image_size ? `${imageAnalysis.image_size[0]} Ã— ${imageAnalysis.image_size[1]} åƒç´ ` : 'æœªçŸ¥'}</td>
                            </tr>
                            <tr>
                                <td><strong>æ–‡ä»¶å¤§å°:</strong></td>
                                <td>${data.file_info?.file_size ? formatFileSize(data.file_info.file_size) : 'æœªçŸ¥'}</td>
                            </tr>
                            <tr>
                                <td><strong>åˆ†ææ—¶é—´:</strong></td>
                                <td>${new Date(imageAnalysis.prediction_time).toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        $('#basic-analysis-content').html(basicHtml);
    }

    // æ˜¾ç¤ºåŒ»å­¦æŠ¥å‘Š
    function displayMedicalReport(data) {
        let reportHtml = '';
        const userChoice = data.user_choice || 'unknown';
        
        if (data.medical_report && !data.medical_report.includes('å¤±è´¥') && !data.medical_report.includes('ä¸å¯ç”¨')) {
            // æ˜¾ç¤ºOllamaç”Ÿæˆçš„å®Œæ•´åŒ»å­¦æŠ¥å‘Š
            const formattedReport = data.medical_report.replace(/\n/g, '<br>');
            let headerClass = 'bg-primary';
            let statusText = '';
            
            if (userChoice === 'ollama') {
                headerClass = 'bg-primary';
                statusText = 'âœ… æŒ‰ç”¨æˆ·é€‰æ‹©ä½¿ç”¨Ollamaç”Ÿæˆ';
            } else if (userChoice === 'ollama_fallback') {
                headerClass = 'bg-warning';
                statusText = 'âš ï¸ ç”¨æˆ·é€‰æ‹©Ollamaä½†é™çº§å¤„ç†';
            }
            
            reportHtml = `
                <div class="card">
                    <div class="card-header ${headerClass} text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-robot me-2"></i>ğŸ¤– å®Œæ•´AIåŒ»å­¦æŠ¥å‘Š (Ollama)</h5>
                            <small class="opacity-75">${statusText}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="medical-report-content" style="line-height: 1.6;">
                            ${formattedReport}
                        </div>
                    </div>
                </div>
            `;
        } else if (data.enhanced_report) {
            // æ˜¾ç¤ºå¢å¼ºç‰ˆåŒ»å­¦æŠ¥å‘Š
            const report = data.enhanced_report;
            let headerClass = 'bg-success';
            let statusText = '';
            
            if (userChoice === 'enhanced') {
                headerClass = 'bg-success';
                statusText = 'âœ… æŒ‰ç”¨æˆ·é€‰æ‹©ç”Ÿæˆå¢å¼ºç‰ˆæŠ¥å‘Š';
            } else if (userChoice === 'enhanced_fallback') {
                headerClass = 'bg-info';
                statusText = 'âš ï¸ ç”¨æˆ·é€‰æ‹©Ollamaä½†ç³»ç»Ÿä¸å¯ç”¨ï¼Œä½¿ç”¨å¢å¼ºç‰ˆ';
            }
            
            reportHtml = `
                <div class="card">
                    <div class="card-header ${headerClass} text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-file-medical-alt me-2"></i>ğŸ“‹ å¢å¼ºç‰ˆåŒ»å­¦åˆ†ææŠ¥å‘Š</h5>
                            <small class="opacity-75">${statusText}</small>
                        </div>
                        <div class="mt-1">
                            <small class="text-light">${report.report_header.ai_system}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- æŠ¥å‘Šæ ‡é¢˜ -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h4 class="text-primary">${report.report_header.title}</h4>
                                <p class="text-muted mb-0">æŠ¥å‘Šç¼–å·: ${report.report_header.report_id}</p>
                                <p class="text-muted mb-0">ç”Ÿæˆæ—¶é—´: ${report.report_header.generated_time}</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-info fs-6">AIåˆ†æç»“æœ</span>
                            </div>
                        </div>

                        <!-- å½±åƒåˆ†æç»“æœ -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-microscope me-2"></i>å½±åƒå­¦åˆ†æ</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>AIé¢„æµ‹:</strong> <span class="badge ${report.imaging_analysis.ai_prediction === 'PNEUMONIA' ? 'bg-warning' : 'bg-success'}">${report.imaging_analysis.ai_prediction === 'PNEUMONIA' ? 'ç–‘ä¼¼è‚ºç‚' : 'æ­£å¸¸'}</span></p>
                                        <p><strong>ç½®ä¿¡åº¦:</strong> ${report.imaging_analysis.confidence_score}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>é£é™©åˆ†å±‚:</strong> <span class="text-primary">${report.imaging_analysis.risk_stratification}</span></p>
                                        <p><strong>ç½®ä¿¡åº¦è§£é‡Š:</strong> ${report.imaging_analysis.confidence_interpretation}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ä¸´åºŠå‘ç° -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-search me-2"></i>ä¸´åºŠå‘ç°</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>ä¸»è¦è§£è¯»:</strong> ${report.clinical_findings.primary_interpretation}</p>
                                
                                <h6 class="mt-3"><i class="fas fa-list me-2"></i>è¯¦ç»†å‘ç°:</h6>
                                <ul>
                                    ${report.clinical_findings.detailed_findings.map(finding => `<li>${finding}</li>`).join('')}
                                </ul>

                                ${report.clinical_findings.differential_diagnosis.length > 0 ? `
                                <h6 class="mt-3"><i class="fas fa-diagnoses me-2"></i>é‰´åˆ«è¯Šæ–­:</h6>
                                <ul>
                                    ${report.clinical_findings.differential_diagnosis.map(diagnosis => `<li>${diagnosis}</li>`).join('')}
                                </ul>
                                ` : ''}

                                ${report.clinical_findings.additional_notes ? `
                                <div class="alert alert-info mt-3">
                                    <strong>é™„åŠ è¯´æ˜:</strong> ${report.clinical_findings.additional_notes}
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- ä¸´åºŠå»ºè®® -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-user-md me-2"></i>ä¸´åºŠå»ºè®®</h6>
                            </div>
                            <div class="card-body">
                                <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i>å³æ—¶è¡ŒåŠ¨å»ºè®®:</h6>
                                <ul>
                                    ${report.clinical_recommendations.immediate_actions.map(action => `<li>${action}</li>`).join('')}
                                </ul>

                                <h6 class="mt-3"><i class="fas fa-calendar-check me-2 text-info"></i>éšè®¿è®¡åˆ’:</h6>
                                <div class="row">
                                    ${Object.entries(report.clinical_recommendations.follow_up_plan).map(([period, plan]) => `
                                        <div class="col-md-6">
                                            <div class="border p-2 mb-2 rounded">
                                                <strong>${period === 'immediate' ? 'å³æ—¶' : period === 'short_term' ? 'çŸ­æœŸ' : period === 'medium_term' ? 'ä¸­æœŸ' : 'é•¿æœŸ'}:</strong><br>
                                                <small>${plan}</small>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>

                                ${report.clinical_recommendations.additional_testing.length > 0 ? `
                                <h6 class="mt-3"><i class="fas fa-flask me-2 text-warning"></i>å»ºè®®çš„é¢å¤–æ£€æŸ¥:</h6>
                                <ul>
                                    ${report.clinical_recommendations.additional_testing.map(test => `<li>${test}</li>`).join('')}
                                </ul>
                                ` : ''}
                            </div>
                        </div>

                        <!-- è´¨é‡æŒ‡æ ‡å’Œé™åˆ¶ -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-chart-bar me-2"></i>è´¨é‡æŒ‡æ ‡ä¸é™åˆ¶</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>æ¨¡å‹æ€§èƒ½:</strong> ${report.quality_metrics.model_performance}</p>
                                <p><strong>éªŒè¯è¯´æ˜:</strong> ${report.quality_metrics.validation_notes}</p>
                                
                                <h6 class="mt-3">ç³»ç»Ÿé™åˆ¶:</h6>
                                <ul class="text-muted">
                                    ${report.quality_metrics.limitations.map(limitation => `<li>${limitation}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- åŒ»ç–—å…è´£å£°æ˜ -->
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>é‡è¦åŒ»ç–—å£°æ˜</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-danger">
                                    <strong><i class="fas fa-ambulance me-2"></i>ç´§æ€¥æƒ…å†µæŒ‡å¯¼:</strong><br>
                                    ${report.medical_disclaimer.emergency_guidance}
                                </div>
                                
                                <ul class="mb-0">
                                    ${report.medical_disclaimer.important_notes.map(note => `<li>${note}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        <small><i class="fas fa-info-circle me-1"></i>${report.report_header.disclaimer}</small>
                    </div>
                </div>
            `;
        } else if (data.medical_advice) {
            // åŸºç¡€åŒ»å­¦å»ºè®®
            let statusText = '';
            if (userChoice === 'enhanced' || userChoice === 'enhanced_fallback') {
                statusText = 'âš ï¸ å¢å¼ºç‰ˆæŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€å»ºè®®';
            } else {
                statusText = 'åŸºç¡€åŒ»å­¦å»ºè®®';
            }
            
            reportHtml = `
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-stethoscope me-2"></i>ğŸ©º åŸºç¡€åŒ»å­¦å»ºè®®</h5>
                            <small class="opacity-75">${statusText}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-${data.medical_advice.urgency === 'urgent' ? 'danger' : data.medical_advice.urgency === 'moderate' ? 'warning' : 'info'}">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>é£é™©ç­‰çº§ï¼š${data.medical_advice.risk_level}</h6>
                            <p class="mb-0">${data.medical_advice.recommendation}</p>
                        </div>
                        
                        <h6><i class="fas fa-lightbulb me-2"></i>ç½®ä¿¡åº¦è§£é‡Š</h6>
                        <p>${data.medical_advice.confidence_interpretation}</p>
                        
                        <h6><i class="fas fa-exclamation-circle me-2"></i>é‡è¦æé†’</h6>
                        <ul>
                            ${data.medical_advice.disclaimers.map(disclaimer => `<li>${disclaimer}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        } else {
            let errorMessage = '';
            if (userChoice === 'ollama') {
                errorMessage = 'ç”¨æˆ·é€‰æ‹©äº†Ollamaå®Œæ•´æŠ¥å‘Šï¼Œä½†ç³»ç»Ÿä¸å¯ç”¨ã€‚è¯·æ£€æŸ¥OllamaæœåŠ¡çŠ¶æ€ã€‚';
            } else if (userChoice === 'enhanced') {
                errorMessage = 'ç”¨æˆ·é€‰æ‹©äº†å¢å¼ºç‰ˆæŠ¥å‘Šï¼Œä½†ç”Ÿæˆå¤±è´¥ã€‚è¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ã€‚';
            } else {
                errorMessage = 'æ‰€æœ‰æŠ¥å‘Šç”Ÿæˆæ–¹å¼éƒ½ä¸å¯ç”¨ã€‚';
            }
            
            reportHtml = `
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>æŠ¥å‘Šç”Ÿæˆä¸å¯ç”¨</h5>
                    </div>
                    <div class="card-body text-center">
                        <i class="fas fa-info-circle fa-3x mb-3 text-warning"></i>
                        <h6>åŒ»å­¦æŠ¥å‘Šç”Ÿæˆå¤±è´¥</h6>
                        <p class="text-muted mb-3">${errorMessage}</p>
                        <div class="alert alert-info">
                            <strong>å»ºè®®ï¼š</strong><br>
                            â€¢ å¦‚é€‰æ‹©Ollama: ç¡®ä¿OllamaæœåŠ¡æ­£åœ¨è¿è¡Œ<br>
                            â€¢ å¦‚é€‰æ‹©å¢å¼ºç‰ˆ: æ£€æŸ¥ç³»ç»Ÿæ¨¡å‹å’Œä¾èµ–<br>
                            â€¢ å½“å‰åªèƒ½æä¾›åŸºç¡€çš„å›¾åƒåˆ†æç»“æœ
                        </div>
                    </div>
                </div>
            `;
        }
        
        $('#medical-report-content').html(reportHtml);
    }

    // æ˜¾ç¤ºå»ºè®®
    function displayRecommendations(data) {
        const assessment = data.comprehensive_assessment;
        let recommendationsHtml = '';
        
        if (assessment && assessment.recommendations) {
            const recs = assessment.recommendations;
            recommendationsHtml = `
                <div class="row">
                    ${recs.immediate_actions?.length ? `
                        <div class="col-md-6 mb-4">
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0"><i class="fas fa-exclamation me-2"></i>ç«‹å³è¡ŒåŠ¨</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        ${recs.immediate_actions.map(action => `<li><i class="fas fa-arrow-right text-danger me-2"></i>${action}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${recs.follow_up?.length ? `
                        <div class="col-md-6 mb-4">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="fas fa-calendar-check me-2"></i>åç»­è·Ÿè¿›</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        ${recs.follow_up.map(action => `<li><i class="fas fa-arrow-right text-warning me-2"></i>${action}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${recs.lifestyle?.length ? `
                        <div class="col-md-6 mb-4">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-heart me-2"></i>ç”Ÿæ´»æ–¹å¼</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        ${recs.lifestyle.map(action => `<li><i class="fas fa-arrow-right text-info me-2"></i>${action}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${recs.when_to_seek_help?.length ? `
                        <div class="col-md-6 mb-4">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-ambulance me-2"></i>ä½•æ—¶å°±åŒ»</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        ${recs.when_to_seek_help.map(condition => `<li><i class="fas fa-arrow-right text-primary me-2"></i>${condition}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                ${assessment.disclaimers?.length ? `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>é‡è¦å£°æ˜</h6>
                        <ul class="mb-0">
                            ${assessment.disclaimers.map(disclaimer => `<li>${disclaimer}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        } else {
            recommendationsHtml = `
                <div class="card">
                    <div class="card-body text-center text-muted">
                        <i class="fas fa-lightbulb fa-3x mb-3"></i>
                        <h5>è¯¦ç»†å»ºè®®ç”Ÿæˆä¸å¯ç”¨</h5>
                        <p>å½“å‰åªèƒ½æä¾›åŸºç¡€åˆ†æç»“æœã€‚</p>
                    </div>
                </div>
            `;
        }
        
        $('#recommendations-content').html(recommendationsHtml);
    }

    // ä¸‹è½½æŠ¥å‘Š
    function downloadReport() {
        if (currentAnalysisId) {
            window.open(`/download/${currentAnalysisId}`, '_blank');
        } else {
            showNotification('æ— æ³•ä¸‹è½½æŠ¥å‘Šï¼šåˆ†æIDä¸å­˜åœ¨', 'error');
        }
    }

    // æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
    function viewDetailedReport() {
        if (currentAnalysisId) {
            window.open(`/report/${currentAnalysisId}`, '_blank');
        } else {
            showNotification('æ— æ³•æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šï¼šåˆ†æIDä¸å­˜åœ¨', 'error');
        }
    }
</script>
{% endblock %} 